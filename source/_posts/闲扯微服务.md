---
title: 闲扯微服务
categories:
- 方法论
date: 2018-02-15 
tags:
- 微服务
---
>微服务，就是`协同工作`，`小而自制`的服务。
>SOA架构强调的是异构系统之间的通信和解耦合。
>微服务架构强调的是系统按业务边界做细粒度的拆分和部署。
>Dubbo和Spring Cloud是框架和组件，SOA和微服务是架构思想。
>

#### 单体架构痛点
`项目过于臃肿`
当大大小小的功能模块都集中在同一项目的时候，整个项目必然会变得臃肿，让开发者难以维护。

`资源无法隔离`
就像刚刚小灰的经历一样，整个单体系统的各个功能模块都依赖于同样的数据库、内存等资源，一旦某个功能模块对资源使用不当，整个系统都会被拖垮。

`无法灵活扩展`
当系统的访问量越来越大的时候，单体系统固然可以进行水平扩展，部署在多台机器上组成集群。但是这种扩展并非灵活的扩展。比如我们现在的性能瓶颈是支付模块，希望只针对支付模块做水平扩展，这一点在单体系统是做不到的。

#### 优势
`技术异构`
不必使用相同的编程语言和技术栈，不同的服务选用最适合自己的技术栈。

`资源隔离`
有效避免了服务之间争用数据库和缓存资源所带来的问题，实现了服务器资源（内存、CPU资源等）的有效隔离。

`灵活扩展`
微服务是以每一个独立组件（例如用户服务，商品服务）为单位进行独立部署，每个服务可以根据业务进行灵活扩展。

#### 局限性
`增加开发复杂度`
原有的进程内接口调用，变成RESTful接口调用。

`增加测试复杂度`
测试依赖其他服务，需要部署其他微服务支撑测试。

`增加运维难度`
原有的单个进程部署，现在需要多个微服务进程，和其他微服务支撑组件部署。

`增加BUG排查难度`
单个业务请求，贯穿多个微服务，需要跟踪多个微服务才能排查问题。

`数据一致性`
为了保证服务间的数据一致性，需要引入分布式事务和补偿机制。

#### 核心组件

`路由网关`
提供动态路由,监控,弹性,安全等边缘服务的框架

`服务注册中心`
用于定位服务，以实现云端中间层服务发现和故障转移。

`配置中心`
可以把配置放到远程服务器，集中化管理集群配置。

`断路器`
通过熔断机制控制服务和第三方库的节点,从而对延迟和故障提供更强大的容错能力。

#### 分布式事务

`CAP原则`
指的是在一个分布式系统中， Consistency（一致性）、 Availability（可用性）、Partition tolerance（分区容错性），三者不可得兼。

`BASE理论`
BASE是Basically Available（基本可用）、Soft state（软状态）和Eventually consistent（最终一致性）三个短语的简写。

`2PC两阶段提交`
2PC顾名思义分为两个阶段，其实施思路可概括为：
（1）投票阶段（voting phase）：参与者将操作结果通知协调者；
（2）提交阶段（commit phase）：收到参与者的通知后，协调者再向参与者发出通知，根据反馈情况决定各参与者是否要提交还是回滚；
 实现复杂，牺牲了可用性，对性能影响较大，不适合高并发高性能场景

`TCC补偿事务`
Try 阶段主要是对业务系统做检测及资源预留。
Confirm 阶段主要是对业务系统做确认提交，Try阶段执行成功并开始执行 Confirm阶段时，默认 Confirm阶段是不会出错的。即：只要Try成功，Confirm一定成功。
Cancel 阶段主要是在业务执行错误，需要回滚的状态下执行的业务取消，预留资源释放。

`本地消息表`
消息生产方，需要额外建一个消息表，并记录消息发送状态。消息表和业务数据要在一个事务里提交，也就是说他们要在一个数据库里面。然后消息会经过MQ发送到消息的消费方。如果消息发送失败，会进行重试发送。
遵循BASE理论，采用的是最终一致性。

`事务消息`
有一些第三方的MQ是支持事务消息的，比如RocketMQ，他们支持事务消息的方式也是类似于采用的二阶段提交。

